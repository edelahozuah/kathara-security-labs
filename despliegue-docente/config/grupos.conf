#!/bin/bash
#
# Configuración global para despliegue docente de escenarios Kathara
# Universidad de Alcalá - Asignatura Seguridad
#

# ============================================
# CONFIGURACIÓN DE GRUPOS
# ============================================

# Número total de grupos a desplegar
NUM_GRUPOS=20

# Prefijo para nombres de directorios
GRUPO_PREFIX="grupo"

# ============================================
# ASIGNACIÓN DE PUERTOS
# ============================================

# Puerto base para WireGuard (VPN)
# Grupo 01: 51820, Grupo 02: 51821, ..., Grupo 20: 51839
BASE_PORT_VPN=51820

# Puerto base para VNC
# Grupo 01: 5901, Grupo 02: 5902, ..., Grupo 20: 5920
BASE_PORT_VNC=5901

# Puerto base para SSH (mapeo a nodos)
# Grupo 01: 22001, Grupo 02: 22002, ..., Grupo 20: 22020
BASE_PORT_SSH=22001

# ============================================
# ASIGNACIÓN DE RANGOS IP
# ============================================

# Red base para LAN de escenarios
# Grupo 01: 192.168.1.0/24, Grupo 02: 192.168.2.0/24, ...
BASE_IP_LAN="192.168"

# Red base para WireGuard
# Grupo 01: 10.99.1.0/24, Grupo 02: 10.99.2.0/24, ...
BASE_IP_WG="10.99"

# ============================================
# RECURSOS POR GRUPO
# ============================================

# Memoria máxima por grupo (ajustar según hardware del servidor)
MEMORIA_POR_GRUPO="2G"

# CPUs por grupo
CPU_POR_GRUPO="2"

# ============================================
# CONFIGURACIÓN DE ACCESO
# ============================================

# Habilitar acceso SSH a nodos
SSH_HABILITADO=true

# Usuario SSH (root por defecto en Kathara)
SSH_USUARIO="root"

# ============================================
# RUTAS
# ============================================

# Directorio base de despliegue
DIR_BASE="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Directorio donde se almacenan los grupos
DIR_GRUPOS="${DIR_BASE}/grupos"

# Directorio de listas de estudiantes
DIR_LISTAS="${DIR_BASE}/listas"

# Directorio de scripts
DIR_SCRIPTS="${DIR_BASE}/scripts"

# ============================================
# PRÁCTICA POR DEFECTO
# ============================================

# Práctica y escenario a desplegar (se puede sobrescribir con parámetros)
PRACTICA_DEFAULT="practica3"
ESCENARIO_DEFAULT="escenario1"

# Ruta al escenario base (relativa a la raíz del repo)
ESCENARIO_BASE="${DIR_BASE}/../${PRACTICA_DEFAULT}/${ESCENARIO_DEFAULT}/kathara"

# ============================================
# VALIDACIÓN
# ============================================

# Verificar que las variables esenciales estén definidas
if [[ -z "$NUM_GRUPOS" || -z "$BASE_PORT_VPN" || -z "$BASE_IP_LAN" ]]; then
    echo "ERROR: Configuración incompleta en grupos.conf"
    exit 1
fi

# Calcular último puerto VPN
ULTIMO_PORT_VPN=$((BASE_PORT_VPN + NUM_GRUPOS - 1))

# Exportar variables para uso en scripts
export NUM_GRUPOS BASE_PORT_VPN BASE_PORT_VNC BASE_PORT_SSH
export BASE_IP_LAN BASE_IP_WG
export MEMORIA_POR_GRUPO CPU_POR_GRUPO
export SSH_HABILITADO SSH_USUARIO
export DIR_BASE DIR_GRUPOS DIR_LISTAS DIR_SCRIPTS
export PRACTICA_DEFAULT ESCENARIO_DEFAULT ESCENARIO_BASE
export ULTIMO_PORT_VPN
